<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bitcoin script execution simulator | BTC Study</title>
    
    <style>
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.98);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.15);
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
            border-bottom: 3px solid #f0f0f0;
            padding-bottom: 30px;
        }
        
        h1 {
            color: #333;
            margin: 0 0 15px 0;
            font-size: 2.8em;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .subtitle {
            color: #666;
            font-size: 1.2em;
            margin-bottom: 20px;
        }
        
        .github-link {
            display: inline-block;
            padding: 10px 20px;
            background: linear-gradient(135deg, #24292e, #586069);
            color: white;
            text-decoration: none;
            border-radius: 25px;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-top: 15px;
        }
        
        .github-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.2);
        }
        
        .transaction-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
            justify-content: center;
        }
        
        .tx-button {
            padding: 18px 25px;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            font-weight: 700;
            font-size: 1.1em;
            transition: all 0.3s ease;
            box-shadow: 0 6px 15px rgba(0,0,0,0.1);
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            color: #495057;
        }
        
        .tx-button.active {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(255, 107, 107, 0.4);
        }
        
        .tx-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        
        .simulator-container {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
            margin-top: 30px;
        }
        
        @media (max-width: 1024px) {
            .simulator-container {
                grid-template-columns: 1fr;
                gap: 25px;
            }
        }
        
        .script-execution {
            background: linear-gradient(135deg, #1a1a1a, #2d2d2d);
            border-radius: 15px;
            padding: 30px;
            color: #fff;
            min-height: 600px;
            box-shadow: 0 15px 30px rgba(0,0,0,0.3);
        }
        
        .current-instruction {
            background: linear-gradient(135deg, #fd79a8, #e84393);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            font-weight: 700;
            text-align: center;
            box-shadow: 0 8px 20px rgba(253, 121, 168, 0.3);
            font-size: 1.1em;
        }
        
        .script-display {
            background: linear-gradient(135deg, #2d3436, #636e72);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            font-family: 'Courier New', monospace;
            color: #ddd;
            overflow-x: auto;
            border: 2px solid rgba(255,255,255,0.1);
        }
        
        .script-part {
            display: inline-block;
            padding: 8px 15px;
            margin: 3px;
            border-radius: 8px;
            transition: all 0.4s ease;
            font-weight: 600;
            white-space: nowrap;
        }
        
        .script-part.executed {
            background: linear-gradient(135deg, #00b894, #00a085);
            color: white;
            box-shadow: 0 4px 8px rgba(0, 184, 148, 0.3);
        }
        
        .script-part.current {
            background: linear-gradient(135deg, #e17055, #d63031);
            color: white;
            box-shadow: 0 4px 15px rgba(225, 112, 85, 0.6);
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .script-part.pending {
            background: rgba(99, 110, 114, 0.3);
            color: #bbb;
            border: 2px dashed rgba(255,255,255,0.2);
        }
        
        .controls {
            display: flex;
            gap: 15px;
            margin-top: 25px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 700;
            transition: all 0.3s ease;
            font-size: 1em;
            box-shadow: 0 6px 15px rgba(0,0,0,0.2);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #00b894, #00a085);
            color: white;
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #74b9ff, #0984e3);
            color: white;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #fd79a8, #e84393);
            color: white;
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            background: #6c757d;
        }
        
        .execution-log {
            background: linear-gradient(135deg, #2d3436, #636e72);
            color: #ddd;
            padding: 20px;
            border-radius: 12px;
            margin-top: 25px;
            max-height: 250px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            border: 2px solid rgba(255,255,255,0.1);
        }
        
        .log-entry {
            margin: 8px 0;
            padding: 8px 12px;
            border-left: 4px solid #74b9ff;
            background: rgba(116, 185, 255, 0.1);
            border-radius: 0 8px 8px 0;
            animation: fadeInSlide 0.5s ease-out;
        }
        
        @keyframes fadeInSlide {
            from { 
                opacity: 0;
                transform: translateX(-20px);
            }
            to { 
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .stack-container {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 15px;
            padding: 30px;
            border: 3px solid rgba(116, 185, 255, 0.2);
            box-shadow: 0 15px 30px rgba(0,0,0,0.1);
        }
        
        .stack-container h3 {
            margin-top: 0;
            text-align: center;
            color: #333;
            font-size: 1.5em;
            margin-bottom: 25px;
        }
        
        .stack {
            min-height: 350px;
            border: 3px dashed #dee2e6;
            border-radius: 12px;
            padding: 20px;
            background: linear-gradient(135deg, #fff, #f8f9fa);
            position: relative;
            box-shadow: inset 0 4px 8px rgba(0,0,0,0.05);
        }
        
        .stack-empty {
            text-align: center;
            color: #6c757d;
            padding: 40px 20px;
            font-style: italic;
            font-size: 1.1em;
        }
        
        .stack-item {
            background: linear-gradient(135deg, #74b9ff, #0984e3);
            color: white;
            padding: 15px 20px;
            margin: 8px 0;
            border-radius: 12px;
            font-family: 'Courier New', monospace;
            font-size: 0.95em;
            word-break: break-all;
            box-shadow: 0 6px 15px rgba(116, 185, 255, 0.3);
            animation: stackPush 0.6s ease-out;
            border: 2px solid rgba(255,255,255,0.2);
        }
        
        @keyframes stackPush {
            from { 
                transform: translateY(-30px) scale(0.8);
                opacity: 0;
            }
            to { 
                transform: translateY(0) scale(1);
                opacity: 1;
            }
        }
        
        .tx-info {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 25px;
            border-left: 6px solid #74b9ff;
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        }
        
        .tx-info h3 {
            margin-top: 0;
            color: #333;
            font-size: 1.4em;
        }
        
        .tx-info code {
            background: rgba(116, 185, 255, 0.1);
            padding: 4px 8px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            color: #0984e3;
            word-break: break-all;
        }
        
        .tx-info .background-info {
            background: rgba(255, 235, 59, 0.1);
            border: 1px solid rgba(255, 193, 7, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            font-size: 0.95em;
            line-height: 1.5;
        }
        
        .tx-info .background-info h4 {
            margin: 0 0 10px 0;
            color: #d4a831;
            font-size: 1.1em;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .mempool-link {
            color: #0984e3;
            text-decoration: none;
            padding: 2px 6px;
            border-radius: 4px;
            transition: all 0.3s ease;
            font-weight: 600;
            background: rgba(116, 185, 255, 0.1);
            border: 1px solid rgba(116, 185, 255, 0.2);
        }
        
        .mempool-link:hover {
            background: rgba(116, 185, 255, 0.2);
            border-color: rgba(116, 185, 255, 0.4);
            text-decoration: underline;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(116, 185, 255, 0.3);
        }
        
        .mempool-link::after {
            content: ' 🔗';
            font-size: 0.8em;
            opacity: 0.7;
        }
        
        .verification-result {
            text-align: center;
            padding: 25px;
            border-radius: 15px;
            margin-top: 25px;
            font-weight: 700;
            font-size: 1.3em;
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        }
        
        .verification-success {
            background: linear-gradient(135deg, #00b894, #00a085);
            color: white;
        }
        
        .verification-fail {
            background: linear-gradient(135deg, #d63031, #b71c1c);
            color: white;
        }
        
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .container {
                padding: 20px;
            }
            
            h1 {
                font-size: 2.2em;
            }
            
            .transaction-selector {
                grid-template-columns: 1fr;
            }
            
            .controls {
                flex-direction: column;
                align-items: center;
            }
            
            .btn {
                width: 100%;
                max-width: 200px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🔗 Bitcoin script execution simulator</h1>
            <p class="subtitle">Interactive visual learning of Bitcoin script verification mechanism</p>
            <a href="https://btcstudy.github.io/" class="github-link" target="_blank">
                🏠 Return to BTC Study Home Page
            </a>
        </div>
        
        <div class="transaction-selector">
            <button class="tx-button active" onclick="selectTransaction('taproot')">
                🟠 Taproot transaction
            </button>
            <button class="tx-button" onclick="selectTransaction('p2pkh')">
                🔵 P2PKH transaction
            </button>
            <button class="tx-button" onclick="selectTransaction('segwit')">
                🟢 SegWit transaction
            </button>
            <button class="tx-button" onclick="selectTransaction('p2sh')">
                🟣 P2SH multisignature transaction
            </button>
        </div>
        
        <div id="txInfo" class="tx-info"></div>
        
        <div class="simulator-container">
            <div class="script-execution">
                <div class="current-instruction" id="currentInstruction">
                    Click "Next" to start the script verification process
                </div>
                
                <div class="script-display" id="scriptDisplay"></div>
                
                <div class="controls">
                    <button class="btn btn-primary" onclick="nextStep()" id="nextBtn">
                        ▶️ Next
                    </button>
                    <button class="btn btn-secondary" onclick="reset()">
                        🔄 Reset
                    </button>
                    <button class="btn btn-danger" onclick="autoExecute()" id="autoBtn">
                        ⚡ Auto execute
                    </button>
                </div>
                
                <div class="execution-log" id="executionLog"></div>
            </div>
            
            <div class="stack-container">
                <h3>📚 Execution stack</h3>
                <div class="stack" id="stack">
                    <div class="stack-empty">Stack is empty, waiting for execution...</div>
                </div>
                <div id="verificationResult"></div>
            </div>
        </div>
    </div>

    <script>
        // 交易数据
        const transactions = {
            taproot: {
                name: "Taproot transaction",
                txid: "41b0d039a2e4487315ddc17f832c6167bb3c53ea7040d65b2ab443425f66e3bc",
                input: {
                    witness: ["d64297e5744a7064a439c093f167ba583b275c19ac7cfce3d400fdeef426907e8ac3e043b8f82b0047fc152f0f1ebf31967799c2a1e882e87e02d36559897639"],
                    prevScript: "OP_1 a36e1c49fbae58a6149a3ed423ca80a66d9e43fc9b5197f35df8b2d289757fc24"
                },
                output: {
                    script: "OP_DUP OP_HASH160 33928f0cd14aa8a6d22019b4e04c1e44a2556e30 OP_EQUALVERIFY OP_CHECKSIG",
                    value: "49,000 sats"
                },
                description: "Transfer from Taproot address to P2PKH address, using Schnorr signature"
            },
            p2pkh: {
                name: "P2PKH traditional transaction",
                txid: "19b59a086d39f61c4067c535a242ead881bc17d9607a68ee3372d6b8466e0a0e",
                input: {
                    scriptSig: "3044022069b3088a1b9e77f2b974ba96e6dfeb3c6c90313150e6f6d0c8339f718778a43f02201fb660514e04293c3fb737736c27a4b4dda53967ec5f88638d732899a4a072cf01 023c81375c0f858b623961aed87ba26595f9c41d0841fd49036ad9cd23d73754a8",
                    prevScript: "OP_DUP OP_HASH160 33928f0cd14aa8a6d22019b4e04c1e44a2556e30 OP_EQUALVERIFY OP_CHECKSIG"
                },
                output: {
                    script: "OP_DUP OP_HASH160 cd040de1a07381fe759df9fe8e34e5218ac72a4a OP_EQUALVERIFY OP_CHECKSIG",
                    value: "800 sats"
                },
                description: "Traditional P2PKH address-to-address transfer, the most classic Bitcoin transaction"
            },
            segwit: {
                name: "SegWit transaction",
                txid: "1b0f6a6165d9df75b82472bfa8efef083c07a9f9ab6dccb88ceef50ab810e3bb",
                input: {
                    witness: [
                        "3044022076e2851692527a8bb563f1618c3ea1ba972b505c35a548c4735f56b6f7c8fc6502202292d3bebf303dd260a846f6fb78650bf517654c3ee77c807b402de0e4ef6e7501",
                        "0284b5951609b76619a1ce7f48977b4312ebe226987166ef044bfb374ceef63af5"
                    ],
                    prevScript: "OP_0 163177c0585515fd30b8b605155953b4007e5767"
                },
                output: {
                    script: "OP_1 d57cb4f060303bcef735b7dd6743bf94fc4e650ad1557ec361af5e7561abdd48",
                    value: "600 sats"
                },
                description: "SegWit address transfer, witness data separation, more efficient transaction format"
            },
            p2sh: {
                name: "P2SH multisignature transaction", 
                txid: "3f979d5628656d8b0c2cdec4b2714ad227f6032c9593cdd086cd2deb9d9e1955",
                input: {
                    scriptSig: "OP_0 304402205b25957a4b8c855c65d32039575cae9a2bbe2f6bb66a3f724206f88a5ddcfcf302204172c0c894910a7e399701dfb49421cb13dded3feb8e47d1d09eecbdf17bfcea01 30440220092588e6b92426650a90090f754333809d6e960d28766f328987fc36d64884fb02203cdb8f11ddbaa9cdcd766ef429a08ace78d33357c55fd7ec7ba00a34e98726d501 52210250be5fc44ec580c387bf45df275aaa8b27e2d7716af31f10eeed357d126bb4d3210284b5951609b76619a1ce7f48977b4312ebe226987166ef044bfb374ceef63af552ae",
                    prevScript: "OP_HASH160 483c8413b41d1079d527cba5fd5be52b4e4305ef OP_EQUAL"
                },
                output: {
                    script: "OP_DUP OP_HASH160 5cdc28533660ee003aadd5bbd883196cab2ff902 OP_EQUALVERIFY OP_CHECKSIG",
                    value: "600 sats"
                },
                description: "2-of-2 multisignature transaction, requires both Alice and Bob signatures to spend"
            }
        };

        let currentTx = 'taproot';
        let scriptInstructions = [];
        let currentStep = 0;
        let stack = [];
        let isAutoExecuting = false;

        function selectTransaction(txType) {
            console.log('selectTransaction called with:', txType);
            
            try {
                // 更新按钮状态
                document.querySelectorAll('.tx-button').forEach(btn => btn.classList.remove('active'));
                
                // 根据交易类型找到对应按钮
                const buttonMap = {
                    'taproot': 0,
                    'p2pkh': 1, 
                    'segwit': 2,
                    'p2sh': 3
                };
                
                const buttons = document.querySelectorAll('.tx-button');
                if (buttons[buttonMap[txType]]) {
                    buttons[buttonMap[txType]].classList.add('active');
                }
                
                // 先更新当前交易类型，再重置
                currentTx = txType;
                
                // 重置所有状态
                currentStep = 0;
                stack = [];
                isAutoExecuting = false;
                
                // 更新UI状态
                document.getElementById('nextBtn').disabled = false;
                document.getElementById('autoBtn').disabled = false;
                document.getElementById('executionLog').innerHTML = '';
                document.getElementById('verificationResult').innerHTML = '';
                document.getElementById('currentInstruction').textContent = 'Click "Next" to start the script verification process';
                
                // 更新交易信息和初始化脚本
                updateTxInfo();
                initializeScript();
                updateStackDisplay();
                
            } catch (e) {
                console.error('Error in selectTransaction:', e);
                // 显示用户友好的错误信息
                document.getElementById('currentInstruction').textContent = 'Initialization failed, please select transaction type again';
            }
        }

        function updateTxInfo() {
            const tx = transactions[currentTx];
            
            // 确定mempool链接
            const networkPath = 'testnet4';
            const mempoolUrl = `https://mempool.space/${networkPath}/tx/${tx.txid}`;
            
            // 获取背景信息
            const backgroundInfo = getBackgroundInfo(currentTx);
            
            const txInfoHtml = `
                <h3>${tx.name}</h3>
                
                <div class="background-info">
                    <h4>📖 Transaction background</h4>
                    <p>${backgroundInfo.description}</p>
                    <p><strong>Technical features:</strong> ${backgroundInfo.features}</p>
                </div>
                
                <p><strong>Transaction ID:</strong> 
                    <a href="${mempoolUrl}" target="_blank" class="mempool-link">${tx.txid}</a>
                </p>
                <p><strong>Description:</strong> ${tx.description}</p>
                <p><strong>Output amount:</strong> ${tx.output.value}</p>
                <p><strong>Network:</strong> Bitcoin Testnet4</p>
            `;
            document.getElementById('txInfo').innerHTML = txInfoHtml;
        }
        
        function getBackgroundInfo(txType) {
            if (txType === 'taproot') {
                return {
                    description: "Taproot is the latest upgrade to Bitcoin (activated in 2021), providing better privacy, scalability, and smart contract functionality. Using Schnorr signature instead of ECDSA.",
                    features: "Schnorr signature (64-byte fixed length), MAST support, lower transaction fees, better privacy"
                };
            } else if (txType === 'segwit') {
                return {
                    description: "SegWit (Segregated Witness) activated in 2017, moved signature data to the witness field, solved the transaction malleability problem, and increased block capacity.",
                    features: "Witness data separation, solved malleability, virtual size calculation, supported by Lightning Network"
                };
            } else if (txType === 'p2sh') {
                return {
                    description: "P2SH (Pay to Script Hash) activated in 2012, allowed complex script functionality such as multisignature, the sender only needs to know the script hash, not the complete script.",
                    features: "Multisignature support, script hash hides complexity, 2-prefix address, needs redeem script"
                };
            } else {
                return {
                    description: "P2PKH is the most classic transaction format of Bitcoin, existing since 2009. Most Bitcoin addresses are in this format, simple and reliable.",
                    features: "ECDSA signature, complete script execution, 1 or 3-prefix address, most compatible format"
                };
            }
        }

        function initializeScript() {
            const tx = transactions[currentTx];

            if (currentTx === 'taproot') {
                scriptInstructions = [
                    { type: 'witness', op: 'PUSH_SCHNORR_SIG', data: tx.input.witness[0] },
                    { type: 'script', op: 'OP_1', data: null },
                    { type: 'script', op: 'PUSH_TAPROOT_PUBKEY', data: 'a36e1c49fbae58a6149a3ed423ca80a66d9e43fc9b5197f35df8b2d289757fc24' },
                    { type: 'verify', op: 'VERIFY_SCHNORR_SIG', data: null }
                ];
            } else if (currentTx === 'segwit') {
                scriptInstructions = [
                    { type: 'witness', op: 'PUSH_SIGNATURE', data: tx.input.witness[0] },
                    { type: 'witness', op: 'PUSH_PUBKEY', data: tx.input.witness[1] },
                    { type: 'scriptpubkey', op: 'OP_0', data: null },
                    { type: 'scriptpubkey', op: 'PUSH_PUBKEY_HASH', data: '163177c0585515fd30b8b605155953b4007e5767' },
                    { type: 'scriptpubkey', op: 'VERIFY_WITNESS_PROGRAM', data: null }
                ];
            } else if (currentTx === 'p2sh') {
                const scriptParts = tx.input.scriptSig.split(' ');
                scriptInstructions = [
                    { type: 'scriptsig', op: 'PUSH_OP_0', data: null },
                    { type: 'scriptsig', op: 'PUSH_ALICE_SIG', data: scriptParts[1] },
                    { type: 'scriptsig', op: 'PUSH_BOB_SIG', data: scriptParts[2] },
                    { type: 'scriptsig', op: 'PUSH_REDEEM_SCRIPT', data: scriptParts[3] },
                    { type: 'script', op: 'OP_HASH160', data: null },
                    { type: 'script', op: 'PUSH_SCRIPT_HASH', data: '483c8413b41d1079d527cba5fd5be52b4e4305ef' },
                    { type: 'script', op: 'OP_EQUAL', data: null },
                    { type: 'script', op: 'OP_VERIFY', data: null },
                    { type: 'redeem', op: 'OP_2', data: null },
                    { type: 'redeem', op: 'PUSH_PUBKEY', data: '0250be5fc44ec580c387bf45df275aaa8b27e2d7716af31f10eeed357d126bb4d3' },
                    { type: 'redeem', op: 'PUSH_PUBKEY', data: '0284b5951609b76619a1ce7f48977b4312ebe226987166ef044bfb374ceef63af5' },
                    { type: 'redeem', op: 'OP_2', data: null },
                    { type: 'redeem', op: 'VERIFY_MULTISIG_2_OF_2', data: null }
                ];
            } else if (currentTx === 'p2pkh') {
                const sigData = tx.input.scriptSig.split(' ')[0];
                const pubkeyData = tx.input.scriptSig.split(' ')[1];
                scriptInstructions = [
                    { type: 'scriptsig', op: 'PUSH_SIGNATURE', data: sigData },
                    { type: 'scriptsig', op: 'PUSH_PUBKEY', data: pubkeyData },
                    { type: 'scriptpubkey', op: 'OP_DUP', data: null },
                    { type: 'scriptpubkey', op: 'OP_HASH160', data: null },
                    { type: 'scriptpubkey', op: 'PUSH_HASH160', data: '33928f0cd14aa8a6d22019b4e04c1e44a2556e30' },
                    { type: 'scriptpubkey', op: 'OP_EQUALVERIFY', data: null },
                    { type: 'scriptpubkey', op: 'OP_CHECKSIG', data: null }
                ];
            } else {
                throw new Error('Unknown transaction type');
            }

            updateScriptDisplay();
        }

        function updateScriptDisplay() {
            const scriptHtml = scriptInstructions.map((inst, index) => {
                let className = 'script-part pending';
                if (index < currentStep) className = 'script-part executed';
                if (index === currentStep) className = 'script-part current';
                
                return `<span class="${className}">${inst.op}</span>`;
            }).join(' ');
            
            document.getElementById('scriptDisplay').innerHTML = scriptHtml;
        }

        function nextStep() {
            if (currentStep >= scriptInstructions.length) {
                verifyTransaction();
                return;
            }

            const instruction = scriptInstructions[currentStep];
            executeInstruction(instruction);
            currentStep++;
            
            updateScriptDisplay();
            updateCurrentInstruction();
            updateStackDisplay();
            
            if (currentStep >= scriptInstructions.length) {
                document.getElementById('nextBtn').disabled = true;
                verifyTransaction();
            }
        }

        function executeInstruction(instruction) {
            const log = document.getElementById('executionLog');
            let logMessage = '';

            switch (instruction.op) {
                // 通用签名和数据推送
                case 'PUSH_SIGNATURE':
                    if (instruction.data) {
                        stack.push(`ECDSA signature: ${instruction.data.substring(0, 16)}...`);
                        logMessage = `Push ECDSA signature to stack (${instruction.data.length/2} bytes)`;
                    } else {
                        stack.push(`ECDSA signature: [signature data]`);
                        logMessage = `Push ECDSA signature to stack`;
                    }
                    break;
                    
                case 'PUSH_SCHNORR_SIG':
                    if (instruction.data) {
                        stack.push(`Schnorr signature: ${instruction.data.substring(0, 16)}...`);
                        logMessage = `Push Schnorr signature to stack (64 bytes)`;
                    } else {
                        stack.push(`Schnorr signature: [signature data]`);
                        logMessage = `Push Schnorr signature to stack (64 bytes)`;
                    }
                    break;
                    
                case 'PUSH_PUBKEY':
                    if (instruction.data) {
                        stack.push(`Public key: ${instruction.data.substring(0, 16)}...`);
                        logMessage = `Push public key to stack (${instruction.data.length/2} bytes)`;
                    } else {
                        stack.push(`Public key: [public key data]`);
                        logMessage = `Push public key to stack`;
                    }
                    break;
                    
                case 'PUSH_TAPROOT_PUBKEY':
                    if (instruction.data) {
                        stack.push(`Taproot public key: ${instruction.data.substring(0, 16)}...`);
                        logMessage = `Push Taproot internal public key to stack`;
                    } else {
                        stack.push(`Taproot public key: [public key data]`);
                        logMessage = `Push Taproot internal public key to stack`;
                    }
                    break;
                    
                case 'PUSH_HASH160':
                case 'PUSH_PUBKEY_HASH':
                    if (instruction.data) {
                        stack.push(`Hash160: ${instruction.data}`);
                        logMessage = `Push public key hash to stack`;
                    } else {
                        stack.push(`Hash160: [hash value]`);
                        logMessage = `Push public key hash to stack`;
                    }
                    break;
                    
                case 'PUSH_SCRIPT_HASH':
                    if (instruction.data) {
                        stack.push(`ScriptHash: ${instruction.data}`);
                        logMessage = `Push script hash to stack`;
                    } else {
                        stack.push(`ScriptHash: [hash value]`);
                        logMessage = `Push script hash to stack`;
                    }
                    break;

                // P2SH特有操作
                case 'PUSH_OP_0':
                    stack.push('OP_0');
                    logMessage = `Push OP_0 (fix CHECKMULTISIG bug)`;
                    break;
                    
                case 'PUSH_ALICE_SIG':
                    if (instruction.data) {
                        stack.push(`Alice signature: ${instruction.data.substring(0, 16)}...`);
                        logMessage = `Push Alice's signature (${instruction.data.length/2} bytes)`;
                    } else {
                        stack.push(`Alice signature: [signature data]`);
                        logMessage = `Push Alice's signature`;
                    }
                    break;
                    
                case 'PUSH_BOB_SIG':
                    if (instruction.data) {
                        stack.push(`Bob signature: ${instruction.data.substring(0, 16)}...`);
                        logMessage = `Push Bob's signature (${instruction.data.length/2} bytes)`;
                    } else {
                        stack.push(`Bob signature: [signature data]`);
                        logMessage = `Push Bob's signature`;
                    }
                    break;
                    
                case 'PUSH_REDEEM_SCRIPT':
                    if (instruction.data) {
                        stack.push(`Redeem script: ${instruction.data.substring(0, 16)}...`);
                        logMessage = `Push redeem script (${instruction.data.length/2} bytes)`;
                    } else {
                        stack.push(`Redeem script: [script data]`);
                        logMessage = `Push redeem script`;
                    }
                    break;

                // 基本操作码
                case 'OP_DUP':
                    if (stack.length > 0) {
                        const top = stack[stack.length - 1];
                        stack.push(top);
                        logMessage = `Duplicate stack top element: ${top.substring(0, 20)}...`;
                    }
                    break;
                    
                case 'OP_HASH160':
                    if (stack.length > 0) {
                        const item = stack.pop();
                        let hash;
                        // 更健壮的判断：只要item以'Redeem script:'开头或长度大于50（一般为redeem script），都视为redeem script
                        if (item.startsWith('Redeem script') || (item.length > 50 && item.includes('5221'))) {
                            hash = 'ScriptHash: 483c8413b41d1079d527cba5fd5be52b4e4305ef';
                        } else if (item.includes('public key')) {
                            // 对于P2PKH，模拟对公钥进行Hash160
                            hash = 'Hash160: 33928f0cd14aa8a6d22019b4e04c1e44a2556e30';
                        } else {
                            const itemParts = item.split(': ');
                            const itemValue = itemParts.length > 1 ? itemParts[1] : item;
                            hash = `Hash160(${itemValue})`;
                        }
                        stack.push(hash);
                        logMessage = `Perform Hash160 operation on stack top element`;
                    }
                    break;
                    
                case 'OP_EQUAL':
                case 'OP_EQUALVERIFY':
                    if (stack.length >= 2) {
                        const b = stack.pop();
                        const a = stack.pop();
                        // 检查多种相等情况
                        let isEqual = false;
                        if (a.includes('ScriptHash') && b.includes('ScriptHash')) {
                            // P2SH脚本哈希比较
                            const hashA = a.includes(':') ? a.split(': ')[1] : a;
                            const hashB = b.includes(':') ? b.split(': ')[1] : b;
                            isEqual = hashA === hashB;
                        } else if (a.includes('Hash160') && b.includes('Hash160')) {
                            // P2PKH公钥哈希比较
                            const hashA = a.includes(':') ? a.split(': ')[1] : a.replace('Hash160(', '').replace(')', '');
                            const hashB = b.includes(':') ? b.split(': ')[1] : b.replace('Hash160(', '').replace(')', '');
                            isEqual = hashA === hashB;
                        }
                        logMessage = `Verify equality: ${isEqual ? '✅ Equal' : '❌ Not equal'}`;
                        // 恢复标准行为：相等时压入TRUE，不等时压入FALSE
                        if (instruction.op === 'OP_EQUAL') {
                            stack.push(isEqual ? 'TRUE' : 'FALSE');
                        }
                    }
                    break;
                    
                case 'OP_CHECKSIG':
                    if (stack.length >= 2) {
                        const pubkey = stack.pop();
                        const sig = stack.pop();
                        stack.push('✅ ECDSA verification successful');
                        logMessage = `ECDSA signature verification: ✅ Successful`;
                    }
                    break;

                // SegWit特有
                case 'OP_0':
                    stack.push('OP_0');
                    logMessage = `Push OP_0 (SegWit version identifier)`;
                    break;
                    
                case 'VERIFY_WITNESS_PROGRAM':
                    logMessage = `Execute Witness program verification: ✅ Successful`;
                    // 清空栈，只留下验证结果
                    stack = [];
                    stack.push('✅ SegWit verification successful');
                    break;

                // Taproot特有
                case 'OP_1':
                    stack.push('OP_1');
                    logMessage = `Push OP_1 (Taproot version identifier)`;
                    break;
                    
                case 'VERIFY_SCHNORR_SIG':
                    logMessage = `Schnorr signature verification: ✅ Successful`;
                    // 清空栈，只留下验证结果
                    stack = [];
                    stack.push('✅ Taproot verification successful');
                    break;

                // P2SH多签特有
                case 'OP_2':
                    stack.push('OP_2');
                    logMessage = `Push OP_2 (Need 2 signatures)`;
                    break;
                    
                case 'VERIFY_MULTISIG_2_OF_2':
                    // 假设栈结构：公钥2, 公钥1, OP_2, Bob签名, Alice签名, OP_0（自顶向下）
                    // 依次弹出：公钥2、公钥1、OP_2、Bob签名、Alice签名、OP_0
                    if (stack.length >= 7) {
                        stack.pop(); // 公钥2
                        stack.pop(); // 公钥1
                        stack.pop(); // OP_2
                        stack.pop(); // Bob签名
                        stack.pop(); // Alice签名
                        stack.pop(); // OP_0
                        stack.pop(); // 再pop一次，确保多余的OP_0被消除
                    } else if (stack.length >= 6) {
                        stack.pop(); // 公钥2
                        stack.pop(); // 公钥1
                        stack.pop(); // OP_2
                        stack.pop(); // Bob签名
                        stack.pop(); // Alice签名
                        stack.pop(); // OP_0
                    }
                    stack.push('✅ 2-of-2 multisignature verification successful');
                    logMessage = `Execute 2-of-2 multisignature verification: ✅ Successful`;
                    break;
                    
                case 'OP_VERIFY':
                    if (stack.length > 0) {
                        const top = stack.pop();
                        if (top === 'TRUE') {
                            logMessage = 'OP_VERIFY: TRUE, pop and continue';
                        } else {
                            logMessage = 'OP_VERIFY: Not TRUE, script failed';
                            stack.push(top); // 保持原状
                            // 可以在这里触发失败提示
                        }
                    }
                    break;
                    
                default:
                    logMessage = `Execute instruction: ${instruction.op}`;
            }

            // 添加日志
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.textContent = `Step ${currentStep + 1}: ${logMessage}`;
            log.appendChild(logEntry);
            log.scrollTop = log.scrollHeight;
        }

        function updateCurrentInstruction() {
            const instructionEl = document.getElementById('currentInstruction');
            
            if (currentStep >= scriptInstructions.length) {
                instructionEl.textContent = 'Script execution completed, performing final verification...';
                return;
            }
            
            const instruction = scriptInstructions[currentStep];
            const descriptions = {
                // 通用操作
                'PUSH_SIGNATURE': 'Push ECDSA signature to execution stack',
                'PUSH_SCHNORR_SIG': 'Push Schnorr signature to execution stack',
                'PUSH_PUBKEY': 'Push public key to execution stack',
                'PUSH_TAPROOT_PUBKEY': 'Push Taproot public key to execution stack',
                'PUSH_HASH160': 'Push Hash160 value to execution stack',
                'PUSH_PUBKEY_HASH': 'Push public key hash to execution stack',
                'PUSH_SCRIPT_HASH': 'Push script hash to execution stack',
                
                // P2SH multisignature operations
                'PUSH_OP_0': 'Push OP_0 to fix CHECKMULTISIG bug',
                'PUSH_ALICE_SIG': 'Push Alice\'s signature',
                'PUSH_BOB_SIG': 'Push Bob\'s signature',
                'PUSH_REDEEM_SCRIPT': 'Push redeem script',
                
                // Basic operation codes
                'OP_DUP': 'Duplicate stack top element',
                'OP_HASH160': 'Perform Hash160 operation on stack top element',
                'OP_EQUALVERIFY': 'Verify whether two stack top elements are equal',
                'OP_EQUAL': 'Compare two stack top elements',
                'OP_CHECKSIG': 'Verify whether ECDSA signature is valid',
                
                // SegWit operations
                'OP_0': 'Push OP_0 as SegWit version identifier',
                'VERIFY_WITNESS_PROGRAM': 'Execute SegWit witness program verification',
                
                // Taproot operations
                'OP_1': 'Push OP_1 as Taproot version identifier',
                'VERIFY_SCHNORR_SIG': 'Perform Schnorr signature verification',
                
                // P2SH multisignature operations
                'OP_2': 'Push number 2 indicating need 2 signatures',
                'VERIFY_MULTISIG_2_OF_2': 'Execute 2-of-2 multisignature verification'
            };
            
            instructionEl.textContent = `Current instruction: ${instruction.op} - ${descriptions[instruction.op] || 'Execute operation'}`;
        }

        function updateStackDisplay() {
            const stackEl = document.getElementById('stack');
            stackEl.innerHTML = '';
            
            if (stack.length === 0) {
                stackEl.innerHTML = '<div class="stack-empty">Stack is empty, waiting for execution...</div>';
                return;
            }
            
            // 从栈顶到栈底显示
            for (let i = stack.length - 1; i >= 0; i--) {
                const item = document.createElement('div');
                item.className = 'stack-item';
                item.textContent = stack[i];
                stackEl.appendChild(item);
            }
        }

        function verifyTransaction() {
            const resultEl = document.getElementById('verificationResult');
            const isValid = stack.length > 0 && (stack[stack.length - 1].includes('✅') || stack[stack.length - 1].includes('✓'));
            
            if (isValid) {
                resultEl.innerHTML = '<div class="verification-result verification-success">✅ Transaction verification successful</div>';
            } else {
                resultEl.innerHTML = '<div class="verification-result verification-fail">❌ Transaction verification failed</div>';
            }
        }

        function reset() {
            currentStep = 0;
            stack = [];
            isAutoExecuting = false;
            
            document.getElementById('nextBtn').disabled = false;
            document.getElementById('autoBtn').disabled = false;
            document.getElementById('executionLog').innerHTML = '';
            document.getElementById('verificationResult').innerHTML = '';
            document.getElementById('currentInstruction').textContent = 'Click "Next" to start the script verification process';
            
            initializeScript();
            updateStackDisplay();
        }

        function autoExecute() {
            if (isAutoExecuting) return;
            
            isAutoExecuting = true;
            document.getElementById('autoBtn').disabled = true;
            
            const interval = setInterval(() => {
                if (currentStep >= scriptInstructions.length) {
                    clearInterval(interval);
                    isAutoExecuting = false;
                    return;
                }
                
                nextStep();
            }, 1500);
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            console.log('JavaScript loaded successfully!');
            updateTxInfo();
            initializeScript();
            updateStackDisplay();
        });
        
        // 添加全局变量测试
        window.selectTransaction = selectTransaction;
        window.nextStep = nextStep;
        window.reset = reset;
        window.autoExecute = autoExecute;
    </script>
</body>
</html>